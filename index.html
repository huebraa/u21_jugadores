<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Inicializa Supabase
  const supabase = supabase.createClient(
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRucHd6dm9rZnlia2hienlnZ3V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNzcwNTksImV4cCI6MjA2NDk1MzA1OX0.d1QdJtCgSMZux2chEYe17Z0uh5vDzkeLab09US2zf7w',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRucHd6dm9rZnlia2hienlnZ3V6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0OTM3NzA1OSwiZXhwIjoyMDY0OTUzMDU5fQ.JMyM0bGjFoptoo8Kc1kNqUQwTtcVdDML0DnBX7kxmJg'
  );

  let jugadoresGlobal = [];

  // Función para insertar jugador
  async function insertarJugador(jugador) {
    const { data, error } = await supabase
      .from('jugadores')
      .insert([jugador]);

    if (error) {
      console.error('Error insertando jugador:', error);
      return { success: false, error };
    }
    return { success: true, data };
  }

  // Carga jugadores desde Supabase
  async function cargarJugadores() {
    const { data, error } = await supabase
      .from('jugadores')
      .select('*')
      .order('posicion')
      .order('nombre');
    if (error) {
      console.error(error);
      return;
    }
    jugadoresGlobal = data || [];
    renderFilter();
    renderTabla();
  }

  // Render filtro país
  function renderFilter() {
    const sel = document.getElementById('filterPais');
    sel.innerHTML = '<option value="all">Todos</option>';
    [...new Set(jugadoresGlobal.map(j => j.pais))]
      .filter(p => p && p.trim() !== '')
      .sort()
      .forEach(p => sel.insertAdjacentHTML('beforeend', `<option value="${p}">${p}</option>`));
  }

  // Render tabla de jugadores
  function renderTabla() {
    const sel = document.getElementById('filterPais').value;
    const txt = document.getElementById('searchNombre').value.toLowerCase();
    const tbody = document.getElementById('tblJugadores');
    tbody.innerHTML = '';

    const jugadores = jugadoresGlobal
      .filter(j => (sel === 'all' || j.pais === sel) &&
                   j.nombre.toLowerCase().includes(txt));

    if (!jugadores.length) {
      tbody.innerHTML = '<tr><td colspan="7">No se encontraron jugadores</td></tr>';
      return;
    }

    jugadores.forEach(j => {
      tbody.insertAdjacentHTML('beforeend', `
<tr>
  <td>${j.nombre}</td>
  <td>${j.posicion}</td>
  <td><img class="flag" src="${getFlag(j.pais)}" />${j.pais}</td>
  <td>${j.equipo}</td>
  <td>${j.anio}</td>
  <td>${j.descripcion}</td>
  <td>
    <button class="action-btn edit-btn" onclick="editar(${j.id})">Editar</button>
    <button class="action-btn delete-btn" onclick="eliminar(${j.id})">Eliminar</button>
  </td>
</tr>`);
    });
  }

  // Mapea país a código de bandera para mostrar imagen
  function getFlag(country) {
    const codes = {
      Finlandia:'fi', Alemania:'de', Italia:'it', 'Países Bajos':'nl',
      Dinamarca:'dk', Rumanía:'ro', Chequia:'cz', Inglaterra:'gb-eng',
      España:'es', Ucrania:'ua', Francia:'fr', Georgia:'ge', Portugal:'pt',
      Eslovaquia:'sk', Polonia:'pl', Angola:'ao'
    };
    return codes[country] ? `https://flagcdn.com/w20/${codes[country]}.png` : '';
  }

  // Evento submit del formulario: insertar o actualizar jugador
  document.getElementById('jugadorForm').onsubmit = async function(e) {
    e.preventDefault();
    const id = document.getElementById('jugadorId').value;
    const jugador = {
      nombre: document.getElementById('nombre').value.trim(),
      posicion: document.getElementById('posicion').value.trim(),
      pais: document.getElementById('pais').value.trim(),
      equipo: document.getElementById('equipo').value.trim(),
      anio: document.getElementById('anio').value.trim(),
      descripcion: document.getElementById('descripcion').value.trim()
    };

    if (id) {
      // Actualizar jugador existente
      const { error } = await supabase.from('jugadores').update(jugador).eq('id', id);
      if (error) {
        document.getElementById('msgForm').textContent = '❌ Error actualizando jugador.';
        console.error(error);
        return;
      }
      document.getElementById('msgForm').textContent = '✏️ Jugador actualizado';
    } else {
      // Insertar nuevo jugador
      const result = await insertarJugador(jugador);
      if (!result.success) {
        document.getElementById('msgForm').textContent = '❌ Error insertando jugador.';
        return;
      }
      document.getElementById('msgForm').textContent = '✅ Jugador añadido';
    }

    document.getElementById('jugadorForm').reset();
    document.getElementById('jugadorId').value = '';
    cargarJugadores();
  };

  // Rellenar formulario para editar jugador
  window.editar = function(id) {
    const j = jugadoresGlobal.find(x => x.id === id);
    if (!j) return;
    ['jugadorId','nombre','posicion','pais','equipo','anio','descripcion'].forEach(k => {
      const input = document.getElementById(k);
      if (input) input.value = j[k] || '';
    });
  };

  // Eliminar jugador
  window.eliminar = async function(id) {
    if (!confirm('¿Eliminar este jugador?')) return;
    const { error } = await supabase.from('jugadores').delete().eq('id', id);
    if (error) {
      console.error(error);
      alert('Error eliminando jugador');
    } else {
      cargarJugadores();
    }
  };

  // Eventos para filtros
  document.getElementById('filterPais').onchange = renderTabla;
  document.getElementById('searchNombre').oninput = renderTabla;

  // Carga inicial
  cargarJugadores();
</script>
